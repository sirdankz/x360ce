name: Build x360ce (Desktop apps)

on:
  workflow_dispatch:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: windows-latest
    strategy:
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Install .NET Framework targeting packs (needed for net45)
        shell: pwsh
        run: |
          choco --version
          choco install -y netfx-4.5.2-devpack

      - name: NuGet restore
        run: nuget restore x360ce.sln

      - name: Build desktop apps (force output to artifacts/out)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $outRoot = Join-Path $PWD "artifacts\out"
          New-Item -ItemType Directory -Force -Path $outRoot | Out-Null

          function Try-Build([string]$proj, [string]$cfg, [string]$plat) {
            Write-Host "Trying $proj  Configuration=$cfg  Platform=$plat"

            & msbuild $proj /m /t:Build `
              /p:Configuration="$cfg" `
              /p:Platform="$plat" `
              /p:BaseOutputPath="$outRoot\" `
              /p:OutputPath="$outRoot\" `
              /v:m

            return ($LASTEXITCODE -eq 0)
          }

          function Build-Project([string]$proj) {
            Write-Host "----"
            Write-Host "Project: $proj"

            $plats = @("Any CPU", "AnyCPU", "x64", "x86", "Win32")
            $cfgs  = @("Release", "Debug")

            foreach ($cfg in $cfgs) {
              foreach ($plat in $plats) {
                if (Try-Build $proj $cfg $plat) {
                  Write-Host "SUCCESS: $proj ($cfg|$plat)"
                  $global:LASTEXITCODE = 0
                  return
                }
              }
            }

            throw "Failed to build $proj with any attempted Configuration/Platform combo."
          }

          $candidates = @(
            "x360ce.App.WPF\x360ce.App.WPF.csproj",
            "x360ce.App\x360ce.App.csproj"
          )

          $found = $false
          foreach ($p in $candidates) {
            if (Test-Path $p) {
              $found = $true
              Build-Project $p
            } else {
              Write-Host "Skipping missing project: $p"
            }
          }

          if (-not $found) {
            Write-Host "No expected desktop projects found. Listing all .csproj files:"
            Get-ChildItem -Recurse -Filter *.csproj | Select-Object FullName
            exit 1
          }

          Write-Host "`n=== Contents of artifacts/out (first 200 files) ==="
          Get-ChildItem -Recurse -Path $outRoot -File | Select-Object -First 200 FullName, Length

      - name: Verify built EXE exists in artifacts/out
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $outRoot = Join-Path $PWD "artifacts\out"

          Write-Host "Searching for EXEs under $outRoot ..."
          $exes = Get-ChildItem -Recurse -Path $outRoot -File -Filter *.exe -ErrorAction SilentlyContinue

          if ($exes.Count -eq 0) {
            Write-Host "No EXEs found under artifacts/out."
            Write-Host "Dumping folder tree for debugging:"
            Get-ChildItem -Recurse -Path $outRoot -Force | Select-Object -First 400 FullName
            throw "Build did not produce an EXE in artifacts/out"
          }

          Write-Host "Found EXEs:"
          $exes | Sort-Object Length -Descending | Select-Object -First 30 FullName, Length | Format-Table -AutoSize

      - name: Package outputs (ONLY artifacts/out)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $outRoot = Join-Path $PWD "artifacts\out"
          $zip = Join-Path $PWD "artifacts\x360ce_desktop_outputs.zip"

          if (Test-Path $zip) { Remove-Item $zip -Force }

          Compress-Archive -Path "$outRoot\*" -DestinationPath $zip -Force

          Write-Host "Created $zip"
          Get-Item $zip | Format-List Name,Length,FullName

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: x360ce_desktop_outputs
          path: artifacts/x360ce_desktop_outputs.zip
