name: Build x360ce (Desktop apps)

on:
  workflow_dispatch:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: windows-latest
    strategy:
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Install .NET Framework targeting packs (needed for net45)
        shell: pwsh
        run: |
          choco --version
          choco install -y netfx-4.5.2-devpack

      - name: NuGet restore
        run: nuget restore x360ce.sln

      - name: Build desktop apps (try Release then Debug)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          function Try-Build([string]$proj, [string]$cfg, [string]$plat) {
            Write-Host "Trying $proj  Configuration=$cfg  Platform=$plat"
            & msbuild $proj /m /t:Build /p:Configuration="$cfg" /p:Platform="$plat"
            return ($LASTEXITCODE -eq 0)
          }

          function Build-Project([string]$proj) {
            Write-Host "----"
            Write-Host "Project: $proj"

            $plats = @("Any CPU", "AnyCPU", "x64", "x86", "Win32")
            $cfgs  = @("Release", "Debug")

            foreach ($cfg in $cfgs) {
              foreach ($plat in $plats) {
                $ok = Try-Build $proj $cfg $plat
                if ($ok) {
                  Write-Host "SUCCESS: $proj ($cfg|$plat)"
                  # Important: clear any previous non-zero exit code
                  $global:LASTEXITCODE = 0
                  return
                }
              }
            }

            throw "Failed to build $proj with any attempted Configuration/Platform combo."
          }

          $candidates = @(
            "x360ce.App.WPF\x360ce.App.WPF.csproj",
            "x360ce.App\x360ce.App.csproj"
          )

          $found = $false
          foreach ($p in $candidates) {
            if (Test-Path $p) {
              $found = $true
              Build-Project $p
            } else {
              Write-Host "Skipping missing project: $p"
            }
          }

          if (-not $found) {
            Write-Host "No expected desktop projects found. Listing all .csproj files:"
            Get-ChildItem -Recurse -Filter *.csproj | Select-Object FullName
            exit 1
          }

          # Final safety: ensure this step exits success
          exit 0

      - name: Package outputs
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          New-Item -ItemType Directory -Force -Path artifacts | Out-Null
          $zip = "artifacts/x360ce_desktop_build.zip"

          # Find likely desktop outputs (EXE) under common build folders
          $roots = @(
            "x360ce.App",
            "x360ce.App.WPF",
            "x360ce.App.Beta",
            "artifacts"
          )

          $foundFiles = @()

          foreach ($r in $roots) {
            if (Test-Path $r) {
              # Look for built executables and important dlls
              $foundFiles += Get-ChildItem -Path $r -Recurse -File -ErrorAction SilentlyContinue `
                | Where-Object {
                    $_.FullName -match '\\(bin|obj|artifacts)\\' -and
                    ($_.Name -match '\.exe$' -or $_.Name -match '\.dll$')
                  }
            }
          }

          # Prefer exes first (what you actually want)
          $exeFiles = $foundFiles | Where-Object { $_.Name -match '\.exe$' }
          if ($exeFiles.Count -eq 0) {
            Write-Host "No EXEs found. Listing top-level Release-ish directories for debugging..."
            Get-ChildItem -Recurse -Directory -ErrorAction SilentlyContinue |
              Where-Object { $_.FullName -match '\\Release\\' -or $_.Name -match 'Release' } |
              Select-Object -First 50 FullName
            exit 1
          }

          Write-Host "Found EXEs:"
          $exeFiles | Select-Object -First 30 FullName | ForEach-Object { Write-Host " - $($_.FullName)" }

          # Create a staging folder and copy only the relevant output directories containing EXEs
          $stage = "artifacts\stage"
          if (Test-Path $stage) { Remove-Item $stage -Recurse -Force }
          New-Item -ItemType Directory -Force -Path $stage | Out-Null

          $exeDirs = $exeFiles | Select-Object -ExpandProperty DirectoryName -Unique

          foreach ($d in $exeDirs) {
            $dest = Join-Path $stage (Split-Path $d -Leaf)
            Copy-Item -Path $d -Destination $dest -Recurse -Force
          }

          if (Test-Path $zip) { Remove-Item $zip -Force }
          Compress-Archive -Path $stage\* -DestinationPath $zip -Force

          Write-Host "Created $zip"
          Get-Item $zip | Format-List Name,Length,FullName

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: x360ce_desktop_build
          path: artifacts/*.zip

