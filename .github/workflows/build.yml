      - name: Build desktop apps (Release)
        shell: pwsh
        run: |
          function Get-ProjectPlatforms([string]$csprojPath) {
            # Try to read <Platforms>AnyCPU;x64</Platforms> etc.
            try {
              [xml]$xml = Get-Content $csprojPath
              $platformNodes = $xml.Project.PropertyGroup.Platforms
              $plats = @()
              foreach ($n in $platformNodes) {
                if ($n -and $n.'#text') {
                  $plats += ($n.'#text' -split ';' | ForEach-Object { $_.Trim() } | Where-Object { $_ })
                }
              }
              return ($plats | Select-Object -Unique)
            } catch {
              return @()
            }
          }

          function Build-Project([string]$p) {
            Write-Host "----"
            Write-Host "Project: $p"

            $plats = Get-ProjectPlatforms $p
            if ($plats.Count -eq 0) {
              # Common fallbacks if <Platforms> isn't present
              $plats = @("Any CPU","AnyCPU","x64","x86","Win32")
            }

            # Prefer AnyCPU first, then x64, then x86/Win32
            $preferred = @("Any CPU","AnyCPU","x64","x86","Win32")
            $ordered = @()
            foreach ($pref in $preferred) {
              if ($plats -contains $pref) { $ordered += $pref }
            }
            foreach ($pl in $plats) {
              if (-not ($ordered -contains $pl)) { $ordered += $pl }
            }

            foreach ($plat in $ordered) {
              Write-Host "Trying Configuration=Release Platform=$plat"
              & msbuild $p /m /p:Configuration=Release /p:Platform="$plat" /t:Build
              if ($LASTEXITCODE -eq 0) {
                Write-Host "SUCCESS: $p (Release|$plat)"
                return
              }
            }

            throw "Failed to build $p with Release on all attempted platforms: $($ordered -join ', ')"
          }

          $projects = @(
            "x360ce.App.WPF\x360ce.App.WPF.csproj",
            "x360ce.App\x360ce.App.csproj"
          )

          $builtAny = $false
          foreach ($p in $projects) {
            if (Test-Path $p) {
              Build-Project $p
              $builtAny = $true
            } else {
              Write-Host "Skipping missing project: $p"
            }
          }

          if (-not $builtAny) {
            Write-Host "No expected desktop projects were found. Listing likely candidates..."
            Get-ChildItem -Recurse -Filter *.csproj | Select-Object FullName
            exit 1
          }
