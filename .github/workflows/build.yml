name: Build x360ce (Desktop apps)

on:
  workflow_dispatch:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: windows-latest
    strategy:
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Install .NET Framework targeting packs (needed for net45)
        shell: pwsh
        run: |
          choco --version
          choco install -y netfx-4.5.2-devpack

      - name: NuGet restore
        run: nuget restore x360ce.sln

      - name: Build desktop apps (try Release then Debug)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          function Try-Build([string]$proj, [string]$cfg, [string]$plat) {
            Write-Host "Trying $proj  Configuration=$cfg  Platform=$plat"
            & msbuild $proj /m /t:Build /p:Configuration="$cfg" /p:Platform="$plat"
            return ($LASTEXITCODE -eq 0)
          }

          function Build-Project([string]$proj) {
            Write-Host "----"
            Write-Host "Project: $proj"

            $plats = @("Any CPU", "AnyCPU", "x64", "x86", "Win32")
            $cfgs  = @("Release", "Debug")

            foreach ($cfg in $cfgs) {
              foreach ($plat in $plats) {
                $ok = Try-Build $proj $cfg $plat
                if ($ok) {
                  Write-Host "SUCCESS: $proj ($cfg|$plat)"
                  # Important: clear any previous non-zero exit code
                  $global:LASTEXITCODE = 0
                  return
                }
              }
            }

            throw "Failed to build $proj with any attempted Configuration/Platform combo."
          }

          $candidates = @(
            "x360ce.App.WPF\x360ce.App.WPF.csproj",
            "x360ce.App\x360ce.App.csproj"
          )

          $found = $false
          foreach ($p in $candidates) {
            if (Test-Path $p) {
              $found = $true
              Build-Project $p
            } else {
              Write-Host "Skipping missing project: $p"
            }
          }

          if (-not $found) {
            Write-Host "No expected desktop projects found. Listing all .csproj files:"
            Get-ChildItem -Recurse -Filter *.csproj | Select-Object FullName
            exit 1
          }

          # Final safety: ensure this step exits success
          exit 0

      - name: Package outputs
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          New-Item -ItemType Directory -Force -Path artifacts | Out-Null
          $zip = "artifacts/x360ce_desktop_build.zip"

          # Look for bin outputs broadly (Release output under bin\Release\...)
          $bins = @()
          if (Test-Path "x360ce.App\bin")     { $bins += "x360ce.App\bin" }
          if (Test-Path "x360ce.App.WPF\bin") { $bins += "x360ce.App.WPF\bin" }

          if ($bins.Count -eq 0) {
            Write-Host "No bin folders found. Listing repo for troubleshooting:"
            Get-ChildItem -Directory | Select-Object Name
            Get-ChildItem -Recurse -Directory -Filter bin | Select-Object FullName
            exit 1
          }

          Write-Host "Packaging these folders:"
          $bins | ForEach-Object { Write-Host " - $_" }

          if (Test-Path $zip) { Remove-Item $zip -Force }
          Compress-Archive -Path $bins -DestinationPath $zip -Force

          Write-Host "Created $zip"
          Get-Item $zip | Format-List Name,Length,FullName

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: x360ce_desktop_build
          path: artifacts/*.zip

