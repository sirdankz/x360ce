name: Build x360ce (Desktop apps)

on:
  workflow_dispatch:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: windows-latest
    strategy:
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Install .NET Framework targeting packs (needed for net45)
        shell: pwsh
        run: |
          choco --version
          choco install -y netfx-4.5.2-devpack

      - name: NuGet restore
        run: nuget restore x360ce.sln

      - name: Build desktop apps (try Release then Debug)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          function Try-Build([string]$proj, [string]$cfg, [string]$plat) {
            Write-Host "Trying $proj  Configuration=$cfg  Platform=$plat"
            & msbuild $proj /m /t:Build /p:Configuration="$cfg" /p:Platform="$plat"
            return ($LASTEXITCODE -eq 0)
          }

          function Build-Project([string]$proj) {
            Write-Host "----"
            Write-Host "Project: $proj"

            $plats = @("Any CPU", "AnyCPU", "x64", "x86", "Win32")
            $cfgs  = @("Release", "Debug")

            foreach ($cfg in $cfgs) {
              foreach ($plat in $plats) {
                $ok = Try-Build $proj $cfg $plat
                if ($ok) {
                  Write-Host "SUCCESS: $proj ($cfg|$plat)"
                  $global:LASTEXITCODE = 0
                  return
                }
              }
            }

            throw "Failed to build $proj with any attempted Configuration/Platform combo."
          }

          $candidates = @(
            "x360ce.App.WPF\x360ce.App.WPF.csproj",
            "x360ce.App\x360ce.App.csproj"
          )

          $found = $false
          foreach ($p in $candidates) {
            if (Test-Path $p) {
              $found = $true
              Build-Project $p
            } else {
              Write-Host "Skipping missing project: $p"
            }
          }

          if (-not $found) {
            Write-Host "No expected desktop projects found. Listing all .csproj files:"
            Get-ChildItem -Recurse -Filter *.csproj | Select-Object FullName
            exit 1
          }

          exit 0

      - name: Find & stage real app outputs
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $stage = Join-Path $PWD "artifacts\stage"
          if (Test-Path $stage) { Remove-Item $stage -Recurse -Force }
          New-Item -ItemType Directory -Force -Path $stage | Out-Null

          # Search only where desktop app outputs should live
          $roots = @("x360ce.App.WPF", "x360ce.App", "x360ce.App.Beta")

          # Find EXEs in bin/Release/Debug, but exclude known tool/resource EXEs
          $badExeNames = @(
            "convert.exe", "svnrev.exe", "netz.exe", "ditool.exe", "XInputTest.exe",
            "DIView.exe", "DXTweak2.exe"
          )

          $foundExe = @()

          foreach ($r in $roots) {
            if (-not (Test-Path $r)) { continue }

            $foundExe += Get-ChildItem -Path $r -Recurse -File -Filter *.exe -ErrorAction SilentlyContinue |
              Where-Object {
                $_.FullName -match '\\(bin|Release|Debug)\\' -and
                ($badExeNames -notcontains $_.Name)
              }
          }

          if ($foundExe.Count -eq 0) {
            Write-Host "No candidate app EXEs found under bin/Release/Debug in x360ce.App*."
            Write-Host "For debugging, here's every EXE under those roots (top 80 by size):"
            $all = @()
            foreach ($r in $roots) {
              if (Test-Path $r) {
                $all += Get-ChildItem -Path $r -Recurse -File -Filter *.exe -ErrorAction SilentlyContinue
              }
            }
            $all | Sort-Object Length -Descending | Select-Object -First 80 FullName, Length | Format-Table -AutoSize
            throw "App EXE not found. Build succeeded but output location/name is unexpected."
          }

          Write-Host "Found candidate app EXEs:"
          $foundExe | Sort-Object Length -Descending | Select-Object FullName, Length | Format-Table -AutoSize

          # Copy the containing directories into stage (keeps DLLs/config next to exe)
          $exeDirs = $foundExe | Select-Object -ExpandProperty DirectoryName -Unique
          foreach ($d in $exeDirs) {
            $leaf = Split-Path $d -Leaf
            $dest = Join-Path $stage $leaf
            Write-Host "Staging folder: $d -> $dest"
            Copy-Item -Path $d -Destination $dest -Recurse -Force
          }

          Write-Host "`nStage contents:"
          Get-ChildItem -Recurse -Path $stage -File | Select-Object -First 200 FullName, Length

      - name: Package staged outputs
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          New-Item -ItemType Directory -Force -Path artifacts | Out-Null
          $zip = Join-Path $PWD "artifacts\x360ce_desktop_outputs.zip"
          if (Test-Path $zip) { Remove-Item $zip -Force }

          Compress-Archive -Path (Join-Path $PWD "artifacts\stage\*") -DestinationPath $zip -Force

          Write-Host "Created $zip"
          Get-Item $zip | Format-List Name,Length,FullName

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: x360ce_desktop_outputs
          path: artifacts/x360ce_desktop_outputs.zip
