name: Build x360ce (Desktop apps)

on:
  workflow_dispatch:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: windows-latest
    strategy:
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Install .NET Framework targeting packs (needed for net45)
        shell: pwsh
        run: |
          choco --version
          choco install -y netfx-4.5.2-devpack

      - name: NuGet restore
        run: nuget restore x360ce.sln

      - name: Build desktop apps (try Release then Debug)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          function Try-Build([string]$proj, [string]$cfg, [string]$plat) {
            Write-Host "Trying $proj  Configuration=$cfg  Platform=$plat"
            & msbuild $proj /m /t:Build /p:Configuration="$cfg" /p:Platform="$plat"
            return ($LASTEXITCODE -eq 0)
          }

          function Build-Project([string]$proj) {
            Write-Host "----"
            Write-Host "Project: $proj"

            $plats = @("Any CPU", "AnyCPU", "x64", "x86", "Win32")
            $cfgs  = @("Release", "Debug")

            foreach ($cfg in $cfgs) {
              foreach ($plat in $plats) {
                $ok = Try-Build $proj $cfg $plat
                if ($ok) {
                  Write-Host "SUCCESS: $proj ($cfg|$plat)"
                  # Clear any previous non-zero exit code from earlier failed attempts
                  $global:LASTEXITCODE = 0
                  return
                }
              }
            }

            throw "Failed to build $proj with any attempted Configuration/Platform combo."
          }

          $candidates = @(
            "x360ce.App.WPF\x360ce.App.WPF.csproj",
            "x360ce.App\x360ce.App.csproj"
          )

          $found = $false
          foreach ($p in $candidates) {
            if (Test-Path $p) {
              $found = $true
              Build-Project $p
            } else {
              Write-Host "Skipping missing project: $p"
            }
          }

          if (-not $found) {
            Write-Host "No expected desktop projects found. Listing all .csproj files:"
            Get-ChildItem -Recurse -Filter *.csproj | Select-Object FullName
            exit 1
          }

          exit 0

      - name: Find built EXEs (log paths)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          Write-Host "Searching for EXEs after build..."
          $exes = Get-ChildItem -Recurse -File -Filter *.exe -ErrorAction SilentlyContinue |
            Where-Object { $_.FullName -notmatch '\\\.git\\' }

          if ($exes.Count -eq 0) {
            Write-Host "No EXEs found anywhere in the repo after build."
          } else {
            Write-Host "Found EXEs (top 50 by size):"
            $exes | Sort-Object Length -Descending | Select-Object -First 50 FullName, Length | Format-Table -AutoSize
          }

      - name: Package outputs (brute force, safe path)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          # Write the zip outside the repo to avoid locking/self-zipping issues
          $outDir = "C:\temp"
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null

          $zip = Join-Path $outDir "x360ce_repo_after_build_${{ github.run_id }}.zip"
          if (Test-Path $zip) { Remove-Item $zip -Force }

          # Exclude .git AND exclude the repo's artifacts folder (prevents zipping a zip)
          $items = Get-ChildItem -Force | Where-Object { $_.Name -ne ".git" -and $_.Name -ne "artifacts" }

          Compress-Archive -Path $items.FullName -DestinationPath $zip -Force

          Write-Host "Created $zip"
          Get-Item $zip | Format-List Name,Length,FullName

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: x360ce_repo_after_build
          path: C:\temp\x360ce_repo_after_build_${{ github.run_id }}.zip
